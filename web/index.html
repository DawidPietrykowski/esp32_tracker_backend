<!DOCTYPE html>
<html lang="en">
<head>
    <title>ESP32 tracker</title>
    <meta charset='utf-8'>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel='stylesheet' href='https://unpkg.com/maplibre-gl@5.17.0/dist/maplibre-gl.css' />
    <script src='https://unpkg.com/maplibre-gl@5.17.0/dist/maplibre-gl.js'></script>
    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        html, body, #map { height: 100%; }

        #recenter-btn {
            position: absolute;
            bottom: 30px;
            right: 20px;
            z-index: 10;
            background-color: white;
            border: 2px solid #ccc;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: all 0.2s;
        }
        #recenter-btn:hover { background-color: #f8f9fa; transform: translateY(-1px); }
        .tracking-active { color: #007bff; border-color: #007bff !important; }
        .tracking-inactive { color: #555; }

        #stats-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 10;
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            min-width: 200px;
        }

        .stat-row { display: flex; justify-content: space-between; margin-bottom: 8px; align-items: center; }
        .stat-label { color: #666; font-size: 0.85rem; font-weight: 500; }
        .stat-value { font-weight: bold; font-size: 1rem; color: #333; }
        
        .main-time { font-size: 1.2rem; margin-bottom: 2px; }
        .sub-time { font-size: 0.8rem; color: #888; margin-bottom: 12px; display: block; }
        
        .high { color: #28a745; }
        .medium { color: #000000; }
        .low { color: #dc3545; }
    </style>
</head>
<body>

<div id="map"></div>

<button id="recenter-btn" class="tracking-active">Target Lock: ON</button>

<div id="stats-panel">
    <div class="stat-value main-time" id="disp-time">Loading...</div>
    <span class="sub-time" id="disp-ago">Waiting for fix...</span>
    
    <div class="stat-row">
        <span class="stat-label">Battery</span>
        <span class="stat-value" id="disp-bat">--%</span>
    </div>
    <div class="stat-row" style="margin-bottom: 0;">
        <span class="stat-label">Signal</span>
        <span class="stat-value" id="disp-sig">--</span>
    </div>
</div>


<script>
    const map = new maplibregl.Map({
        container: 'map',
        style: 'https://tiles.openfreemap.org/styles/bright',
        zoom: 1,
        center: [0, 0],
        attributionControl: {
            compact: false
        }
    });

    let isFollowing = true; 
    let latestCoordinates = [0, 0];

    const btn = document.getElementById('recenter-btn');
    const elTime = document.getElementById('disp-time');
    const elAgo = document.getElementById('disp-ago');
    const elBat = document.getElementById('disp-bat');
    const elSig = document.getElementById('disp-sig');

    function getTimeAgo(timestamp) {
        const seconds = Math.floor(Date.now() / 1000) - timestamp;
        if (seconds < 5) return "Just now";
        if (seconds < 60) return `${seconds}s ago`;
        if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
        return `${Math.floor(seconds / 3600)}h ago`;
    }

    function updateBatteryUI(level) {
        level *= 100.0;
        if (!level && level !== 0) return { text: 'N/A', class: '' };
        let colorClass = 'high';
        if (level < 50) colorClass = 'medium';
        if (level < 20) colorClass = 'low';
        return { text: level.toFixed(2) + '%', class: colorClass };
    }

    function updateDashboard(data) {
        const date = new Date(data.generated * 1000);
        
        elTime.innerText = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        elAgo.innerText = getTimeAgo(data.generated);

        const batInfo = updateBatteryUI(data.battery);
        elBat.innerText = batInfo.text;
        elBat.className = "stat-value " + batInfo.class;

        const signal = data.signal !== undefined ? (data.signal * 100).toFixed(2) + '%' : 'N/A';
        elSig.innerText = signal;
    }

    btn.addEventListener('click', () => {
        isFollowing = true;
        updateButtonState();
        map.flyTo({ center: latestCoordinates, speed: 2 });
    });

    // Disable following on drag
    map.on('dragstart', () => {
        isFollowing = false;
        updateButtonState();
    });

    function updateButtonState() {
        if(isFollowing) {
            btn.textContent = "Position Lock: ON (Drag to disable)";
            btn.className = "tracking-active";
        } else {
            btn.textContent = "Position Lock: OFF";
            btn.className = "tracking-inactive";
        }
    }
    updateButtonState();

    map.on('load', async () => {
        const url = new URL(window.location).origin + '/pos';

        // Add SVG icon
        const svg = `
        <svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
            <circle cx="20" cy="20" r="18" fill="#4285F4" stroke="#ffffff" stroke-width="4"/>
        </svg>`;
        const image = new Image(40, 40);
        image.src = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svg);
        // Ensure it's loaded
        await new Promise(resolve => {
            image.onload = () => {
                map.addImage('blue-dot', image);
                resolve();
            };
        });

        // Convert json from backend to geojson
        const getGeoJson = (data) => {
            return {
                type: 'Feature',
                geometry: { type: 'Point', coordinates: [data.longitude, data.latitude] },
            };
        };

        try {
            const response = await fetch(url);
            const initialData = await response.json();
            const initialGeoJson = getGeoJson(initialData);

            latestCoordinates = [initialData.longitude, initialData.latitude];
            updateDashboard(initialData);

            map.addSource('esp32', { type: 'geojson', data: initialGeoJson });
            map.addLayer({
                'id': 'esp32',
                'type': 'symbol',
                'source': 'esp32',
                'layout': {
                    'icon-image': 'blue-dot',
                    'icon-size': 0.6,
                }
            });

            map.jumpTo({ center: latestCoordinates, zoom: 15 });

            // Start loop
            window.setInterval(() => {
                fetch(url)
                    .then(r => r.json())
                    .then(data => {
                        const json = getGeoJson(data);
                        latestCoordinates = [data.longitude, data.latitude];
                        map.getSource('esp32').setData(json);

                        updateDashboard(data);

                        if (isFollowing) {
                            map.easeTo({
                                center: latestCoordinates
                            });
                        }
                    });
            }, 500);

        } catch (error) {
            console.error("Error loading map data:", error);
        }
    });
</script>
</body>
</html>
